<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <!--<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">-->

    <title>Devices</title>
    <meta name="description" content="Ability to add IoT platforms">
    <meta name="author" content="Hydrobase">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Basic Styles -->
    <link rel="stylesheet" type="text/css" media="screen" href="../../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

    <!-- SmartAdmin Styles : Caution! DO NOT change the order -->
    <link rel="stylesheet" type="text/css" media="screen" href="../../static/css/smartadmin-production-plugins.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../../static/css/smartadmin-production.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../../static/css/smartadmin-skins.min.css">

    <!-- SmartAdmin RTL Support  -->
    <link rel="stylesheet" type="text/css" media="screen" href="../../static/css/smartadmin-rtl.min.css">

    <!-- We recommend you use "your_style.css" to override SmartAdmin
         specific styles this will also ensure you retrain your customization with each SmartAdmin update.-->
    <link rel="stylesheet" type="text/css" media="screen" href="../../static/css/custom_style.css">

    <!-- Demo purpose only: goes with demo.js, you can delete this css when designing your own WebApp
    <link rel="stylesheet" type="text/css" media="screen" href="css/demo.min.css">-->

    <!-- FAVICONS -->
    <link rel="shortcut icon" href="../../static/img/favicon/hydrosmart_logo.png" type="image/x-icon">
    <link rel="icon" href="../../static/img/favicon/hydrosmart_logo.png" type="image/x-icon">

    <!-- GOOGLE FONT -->
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,300,400,700">

    <!-- Specifying a Webpage Icon for Web Clip
         Ref: https://developer.apple.com/library/ios/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html -->
    <link rel="apple-touch-icon" href="../../static/img/splash/sptouch-icon-iphone.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../../static/img/splash/touch-icon-ipad.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../../static/img/splash/touch-icon-iphone-retina.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../../static/img/splash/touch-icon-ipad-retina.png">

    <!-- iOS web-app metas : hides Safari UI Components and Changes Status Bar Appearance -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <!-- Startup image for web apps -->
    <link rel="apple-touch-startup-image" href="../../static/img/splash/ipad-landscape.png" media="screen and (min-device-width: 481px) and (max-device-width: 1024px) and (orientation:landscape)">
    <link rel="apple-touch-startup-image" href="../../static/img/splash/ipad-portrait.png" media="screen and (min-device-width: 481px) and (max-device-width: 1024px) and (orientation:portrait)">
    <link rel="apple-touch-startup-image" href="../../static/img/splash/iphone.png" media="screen and (max-device-width: 320px)">

</head>

<!--

TABLE OF CONTENTS.

Use search to find needed section.

===================================================================

|  01. #CSS Links                |  all CSS links and file paths  |
|  02. #FAVICONS                 |  Favicon links and file paths  |
|  03. #GOOGLE FONT              |  Google font link              |
|  04. #APP SCREEN / ICONS       |  app icons, screen backdrops   |
|  05. #BODY                     |  body tag                      |
|  06. #HEADER                   |  header tag                    |
|  07. #PROJECTS                 |  project lists                 |
|  08. #TOGGLE LAYOUT BUTTONS    |  layout buttons and actions    |
|  09. #MOBILE                   |  mobile view dropdown          |
|  10. #SEARCH                   |  search field                  |
|  11. #NAVIGATION               |  left panel & navigation       |
|  12. #RIGHT PANEL              |  right panel userlist          |
|  13. #MAIN PANEL               |  main panel                    |
|  14. #MAIN CONTENT             |  content holder                |
|  15. #PAGE FOOTER              |  page footer                   |
|  16. #SHORTCUT AREA            |  dropdown shortcuts area       |
|  17. #PLUGINS                  |  all scripts and plugins       |

===================================================================

-->

<!-- #BODY -->
<!-- Possible Classes

    * 'smart-style-{SKIN#}'
    * 'smart-rtl'         - Switch theme mode to RTL
    * 'menu-on-top'       - Switch to top navigation (no DOM change required)
    * 'no-menu'			  - Hides the menu completely
    * 'hidden-menu'       - Hides the main menu but still accessable by hovering over left edge
    * 'fixed-header'      - Fixes the header
    * 'fixed-navigation'  - Fixes the main menu
    * 'fixed-ribbon'      - Fixes breadcrumb
    * 'fixed-page-footer' - Fixes footer
    * 'container'         - boxed layout mode (non-responsive: will not work with fixed-navigation & fixed-ribbon)
-->
<body class="smart-style-3 fixed-header fixed-navigation">

<!-- HEADER -->
<header id="header">
    <div id="logo-group">

        <!-- PLACE YOUR LOGO HERE -->
        <span id="logo"> <a href="/index"><img src="../../static/img/logo1.png" alt="SmartAdmin"> </a></span>
        <!-- END LOGO PLACEHOLDER -->

        <!-- Note: The activity badge color changes when clicked and resets the number to 0
        Suggestion: You may want to set a flag when this happens to tick off all checked messages / notifications -->
        <span id="activity" class="activity-dropdown hidden-xs"> <i class="fa fa-exclamation-circle"></i> <b class="badge"> 21 </b> </span>

        <!-- AJAX-DROPDOWN : control this dropdown height, look and feel from the LESS variable file -->
        <div class="ajax-dropdown">

            <!-- the ID links are fetched via AJAX to the ajax container "ajax-notifications" -->
            <div class="btn-group btn-group-justified" data-toggle="buttons">
                <label class="btn btn-default">
                    <input type="radio" name="activity" id="ajax/notify/mail.html">
                    Msgs (14) </label>
                <label class="btn btn-default">
                    <input type="radio" name="activity" id="ajax/notify/notifications.html">
                    notify (3) </label>
                <label class="btn btn-default">
                    <input type="radio" name="activity" id="ajax/notify/tasks.html">
                    Tasks (4) </label>
            </div>

            <!-- notification content -->
            <div class="ajax-notifications custom-scroll">

                <div class="alert alert-transparent">
                    <h4>Click a button to show messages here</h4>
                    This blank page message helps protect your privacy, or you can show the first message here automatically.
                </div>

                <i class="fa fa-lock fa-4x fa-border"></i>

            </div>
            <!-- end notification content -->

            <!-- footer: refresh area -->
					<span> Last updated on: 12/12/2013 9:43AM
						<button type="button" data-loading-text="<i class='fa fa-refresh fa-spin'></i> Loading..." class="btn btn-xs btn-default pull-right">
                            <i class="fa fa-refresh"></i>
                        </button>
					</span>
            <!-- end footer -->

        </div>
        <!-- END AJAX-DROPDOWN -->
    </div>

    <!-- pulled right: nav area -->
    <div class="pull-right">

        <!-- collapse menu button -->
        <div id="hide-menu" class="btn-header pull-right">
            <span> <a href="javascript:void(0);" data-action="toggleMenu" title="Collapse Menu"><i class="fa fa-reorder"></i></a> </span>
        </div>
        <!-- end collapse menu -->

        <!-- #MOBILE -->
        <!-- Top menu profile link : this shows only when top menu is active -->
        <ul id="mobile-profile-img" class="header-dropdown-list hidden-xs padding-5">
            <li class="">
                <a href="#" class="dropdown-toggle no-margin userdropdown" data-toggle="dropdown">
                    <img src="../../static/img/avatars/sunny.png" alt="John Doe" class="online" />
                </a>
                <ul class="dropdown-menu pull-right">
                    <li>
                        <a href="javascript:void(0);" class="padding-10 padding-top-0 padding-bottom-0"><i class="fa fa-cog"></i> Setting</a>
                    </li>
                    <li class="divider"></li>
                    <li>
                        <a href="profile.html" class="padding-10 padding-top-0 padding-bottom-0"> <i class="fa fa-user"></i> <u>P</u>rofile</a>
                    </li>
                    <li class="divider"></li>
                    <li>
                        <a href="javascript:void(0);" class="padding-10 padding-top-0 padding-bottom-0" data-action="toggleShortcut"><i class="fa fa-arrow-down"></i> <u>S</u>hortcut</a>
                    </li>
                    <li class="divider"></li>
                    <li>
                        <a href="javascript:void(0);" class="padding-10 padding-top-0 padding-bottom-0" data-action="launchFullscreen"><i class="fa fa-arrows-alt"></i> Full <u>S</u>creen</a>
                    </li>
                    <li class="divider"></li>
                    <li>
                        <a href="login.html" class="padding-10 padding-top-5 padding-bottom-5" data-action="userLogout"><i class="fa fa-sign-out fa-lg"></i> <strong><u>L</u>ogout</strong></a>
                    </li>
                </ul>
            </li>
        </ul>

        <!-- logout button -->
        <div id="logout" class="btn-header transparent pull-right">
            <span> <a href="/logout" title="Sign Out" data-action="userLogout" data-logout-msg="You can improve your security further after logging out by closing this opened browser"><i class="fa fa-sign-out"></i></a> </span>
        </div>
        <!-- end logout button -->

        <!-- fullscreen button -->
        <div id="fullscreen" class="btn-header transparent pull-right">
            <span> <a href="javascript:void(0);" data-action="launchFullscreen" title="Full Screen"><i class="fa fa-arrows-alt"></i></a> </span>
        </div>
        <!-- end fullscreen button -->

    </div>
    <!-- end pulled right: nav area -->

</header>
<!-- END HEADER -->

<!-- Left panel : Navigation area -->
<!-- Note: This width of the aside area can be adjusted through LESS variables -->
<aside id="left-panel">

    <!-- User info -->
    <div class="login-info">
				<span> <!-- User image size is adjusted inside CSS, it should stay as it -->

					<a href="javascript:void(0);" id="show-shortcut" data-action="toggleShortcut">
                        <img src="{{'../../static/img/users/'+username+'.jpeg'}}" alt="me" class="online" />
						<span>
							{{username}}
						</span>
                        <i class="fa fa-angle-down"></i>
                    </a>

				</span>
    </div>
    <!-- end user info -->

    <!-- NAVIGATION : This navigation is also responsive-->
    <nav>
        <ul>
            <li>
                <a href="/dashboard" title="Dashboard"><i class="fa fa-lg fa-fw fa-home"></i> <span class="menu-item-parent">Dashboard</span></a>
            </li>
            <li class="active">
                <a href="/devices"><i class="fa fa-lg fa-fw fa-cogs"></i> <span class="menu-item-parent">Devices</span></a>
            </li>
            <li>
                <a href="#"><i class="fa fa-lg fa-fw fa-pagelines"></i> <span class="menu-item-parent">Grows</span></a>
                <ul>
                    {% for grow in my_grows %}
                    <li>
                        <a href="{{'/grows/'+grow[0]}}">{{grow[0]}}</a>
                    </li>
                    {% endfor %}
                </ul>
            </li>
            <li>
                <a href="/plant_profiles"><i class="fa fa-lg fa-fw fa-pencil-square-o"></i> <span class="menu-item-parent">Plant Profiles</span></a>
            </li>
            <li>
                <a href="/documentation"><i class="fa fa-lg fa-fw fa-file-text"></i> <span class="menu-item-parent">Documentation</span></a>
            </li>
        </ul>
    </nav>
        <span class="minifyme" data-action="minifyMenu">
            <i class="fa fa-arrow-circle-left hit"></i>
        </span>

</aside>
<!-- END NAVIGATION -->

<!-- MAIN PANEL -->
<div id="main" role="main">
    <!-- RIBBON -->
    <div id="ribbon">

				<span class="ribbon-button-alignment">
					<span id="refresh" class="btn btn-ribbon" data-action="resetWidgets" data-title="refresh"  rel="tooltip" data-placement="bottom" data-original-title="<i class='text-warning fa fa-warning'></i> Warning! This will reset all your widget settings." data-html="true">
						<i class="fa fa-refresh"></i>
					</span>
				</span>

        <!-- breadcrumb -->
        <ol class="breadcrumb">
            <li>Hydrosmart</li><li>Devices</li>
        </ol>
        <!-- end breadcrumb -->

        <!-- You can also add more buttons to the
        ribbon for further usability

        Example below:

        <span class="ribbon-button-alignment pull-right">
        <span id="search" class="btn btn-ribbon hidden-xs" data-title="search"><i class="fa-grid"></i> Change Grid</span>
        <span id="add" class="btn btn-ribbon hidden-xs" data-title="add"><i class="fa-plus"></i> Add</span>
        <span id="search" class="btn btn-ribbon" data-title="search"><i class="fa-search"></i> <span class="hidden-mobile">Search</span></span>
        </span> -->

    </div>
    <!-- END RIBBON -->

    <!-- MAIN CONTENT -->
    <div id="content">

        <div class="row">
            <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
                <h1 class="page-title txt-color-blueDark"><i class="fa-fw fa fa-cogs"></i> Devices</h1>
            </div>
        </div>
        <!-- widget grid -->
        <section id="widget-grid">
            <!-- start row -->
            <div class="row">
                {% for device in my_devices %}
                    <article class="col-sm-12 col-md-12 col-lg-6">
                        <!-- start of widget -->
                        <div class="jarviswidget jarviswidget-color-greenDark" id="wid-id_{{device[0]}}" data-widget-colorbutton="false" data-widget-editbutton="false" data-widget-deletebutton="false" data-widget-sortable="false" data-widget-fullscreenbutton="false">
                            <header>
                                <span class="widget-icon"> <i class="fa fa-code-fork"></i> </span>
                                <h2><strong>{{device[0]}} : </strong> <i>{{device[1]}}</i></h2>

                            </header>

                            <!-- widget div-->
                            <div>
                                <!-- widget content -->
                                <div class="widget-body">
                                    {% if device[1] == "ESP32" %}
                                    <img src="../../static/img/ESP32.png">
                                    {% elif device[1] == "Raspberry Pi" %}
                                    <img src="../../static/img/raspberry_pi2.png">
                                    {% endif %}
                                    <div class="panel-group" role="tablist">
                                        <div class="panel panel-default">
                                            <div class="panel-heading" role="tab" id=" {{ 'collapseListGroupHeading_sensors' + device[0]}}">
                                                <h4 class="panel-title">
                                                <a class="collapsed" role="button" data-toggle="collapse" href="{{'#collapseListGroup_sensors_'+ device[0]}}" aria-expanded="false" aria-controls="{{'#collapseListGroup_sensors_'+ device[0]}}">
                                                    Sensors
                                                </a>
                                                </h4>
                                            </div>
                                            <div id="{{ 'collapseListGroup_sensors_'+device[0]}}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="collapseListGroupHeading_sensors">
                                                <ul class="list-group">
                                                {% for sensor in device[2] %}
                                                    <li class="list-group-item">{{sensor.replace('_', ' ')}}</li>
                                                {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel-group" role="tablist">
                                        <div class="panel panel-default">
                                            <div class="panel-heading" role="tab" id="{{ 'collapseListGroupHeading_actuators_' + device[0]}}">
                                                <h4 class="panel-title">
                                                    <a class="collapsed" role="button" data-toggle="collapse" href="{{ '#collapseListGroup_actuators_' + device[0]}}" aria-expanded="false" aria-controls="collapseListGroup_actuators">
                                                        Actuators
                                                    </a>
                                                </h4>
                                            </div>
                                            <div id="{{ 'collapseListGroup_actuators_' + device[0]}}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="collapseListGroupHeading_actuators">
                                                <ul class="list-group">
                                                    {% for key, value in device[3].items() %}
                                                        <li class="list-group-item">{{key.replace('_', ' ')}}<span class="pull-right">Pin: {{value}}</span></li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <button id="{{device[0] + '_edit_btn'}}" class="pull-right btn btn-primary edit-btn" data-toggle="modal" data-target="{{ '#' + device[0]+'modal'}}">Edit</button>
                                    <div id="{{ device[0]+'modal'}}" class="modal fade" role="dialog">
                                        <div class="modal-dialog">
                                            <!-- Modal content-->
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                                    <h4 class="modal-title">Edit {{device[0]}}</h4>
                                                </div>
                                                <div class="col col-12 emergency_stop_div" id="{{device[5]}}_emergency_stop_div">
                                                    {%if device[6] == "false"%}
                                                        <button id="{{device[5]}}_emergency_stop" class="btn btn-warning emergency_stop" style="width:100%">Emergency Stop</button>
                                                    {%endif%}
                                                    {%if device[6] == "true"%}
                                                    <button id="{{device[5]}}_emergency_stop_off" class="btn btn-info emergency_stop_off" style="width:100%">Emergency Stop Off</button>
                                                    {%endif%}
                                                </div>
                                                <div class="modal-body">
                                                    <form class="smart-form edit_device_form" id="{{device[0]}}_edit_device_form" action="{{'/edit_device/'+device[5]}}" method="POST">
                                                        <fieldset>
                                                            <section>
                                                                <label class="label">Device Name </label>
                                                                <label class="input">
                                                                    <input name="device_name" value="{{device[0]}}" type="text" placeholder="{{device[0]}}" class="input-sm">
                                                                </label>
                                                            </section>
                                                        </fieldset>
                                                        <section id="{{device[0] + 'setUp'}}">
                                                            <header>
                                                                {{device[0]}} Set Up
                                                            </header>
                                                            <fieldset>
                                                                <section>
                                                                    <label class="label"><h4>Sensors</h4></label>
                                                                    <div class="row">
                                                                            {%if device[2]|length>4%}
                                                                            <div class="col col-6">
                                                                                {% for sensor in device[2][0:4] %}
                                                                                <label class="checkbox">
                                                                                    <input type="checkbox" name="{{sensor}}" id="{{device[0]+'_'+sensor + '_checkbox'}}" checked="checked">
                                                                                    <input type="hidden" name="{{sensor}}" id="{{device[0] + '_' + sensor + '_checkbox_hidden'}}" value="off">
                                                                                    <i></i>{{sensor.replace('_', ' ')}}
                                                                                </label>
                                                                                {% endfor %}
                                                                            </div>
                                                                            <div class="col col-6">
                                                                                {% for sensor in device[2][4:] %}
                                                                                <label class="checkbox">
                                                                                    <input type="checkbox" name="{{sensor}}" id="{{device[0]+'_'+sensor + '_checkbox'}}" checked="checked">
                                                                                    <input type="hidden" name="{{sensor}}" id="{{device[0] + '_' + sensor + '_checkbox_hidden'}}" value="off">
                                                                                    <i></i>{{sensor.replace('_', ' ')}}
                                                                                </label>
                                                                                {% endfor %}
                                                                                {% for sensor in ['Lux', 'Water_Temp', 'Air_Temp', 'Humidity', 'pH', 'EC', 'TDS', 'PS'] %}
                                                                                    {%if sensor not in device[2]%}
                                                                                        <label class="checkbox">
                                                                                            <input type="checkbox" name="{{sensor}}" id="{{device[0] + '_'+sensor}}_checkbox">
                                                                                            <input type="hidden" name="{{sensor}}" id="{{device[0] + '_'+sensor}}_checkbox_hidden" value="off">
                                                                                            <i></i>{{sensor}}
                                                                                        </label>
                                                                                    {%endif%}
                                                                                {%endfor%}
                                                                            </div>
                                                                            {%endif%}
                                                                            {%if device[2]|length == 4%}
                                                                            <div class="col col-6">
                                                                                {% for sensor in device[2] %}
                                                                                <label class="checkbox">
                                                                                    <input type="checkbox" name="{{sensor}}" id="{{device[0]+'_'+sensor + '_checkbox'}}" checked="checked">
                                                                                    <input type="hidden" name="{{sensor}}" id="{{device[0] + '_' + sensor + '_checkbox_hidden'}}" value="off">
                                                                                    <i></i>{{sensor.replace('_', ' ')}}
                                                                                </label>
                                                                                {% endfor %}
                                                                            </div>
                                                                            <div class="col col-6">
                                                                                {% for sensor in ['Lux', 'Water_Temp', 'Air_Temp', 'Humidity', 'pH', 'EC', 'TDS', 'PS'] %}
                                                                                    {%if sensor not in device[2]%}
                                                                                    <label class="checkbox">
                                                                                        <input type="checkbox" name="{{sensor}}" id="{{device[0] + '_'+sensor}}_checkbox">
                                                                                        <input type="hidden" name="{{sensor}}" id="{{device[0] + '_'+sensor}}_checkbox_hidden" value="off">
                                                                                        <i></i>{{sensor}}
                                                                                    </label>
                                                                                    {%endif%}
                                                                                {%endfor%}
                                                                            </div>
                                                                            {%endif%}
                                                                            {%if device[2]|length<4%}
                                                                                <div class="col col-6">
                                                                                    {% for sensor in device[2] %}
                                                                                    <label class="checkbox">
                                                                                        <input type="checkbox" name="{{sensor}}" id="{{device[0]+'_'+sensor + '_checkbox'}}" checked="checked">
                                                                                        <input type="hidden" name="{{sensor}}" id="{{device[0] + '_' + sensor + '_checkbox_hidden'}}" value="off">
                                                                                        <i></i>{{sensor.replace('_', ' ')}}
                                                                                    </label>
                                                                                    {% endfor %}
                                                                                    {%set count = (device[2]|length)%}
                                                                                        {% for sensor in ['Lux', 'Water_Temp', 'Air_Temp', 'Humidity', 'pH', 'EC', 'TDS', 'PS'] %}
                                                                                            {%set count = count+1%}
                                                                                            {%if sensor not in device[2] and count < 4%}
                                                                                                <label class="checkbox">
                                                                                                    <input type="checkbox" name="{{sensor}}" id="{{device[0] + '_'+sensor}}_checkbox">
                                                                                                    <input type="hidden" name="{{sensor}}" id="{{device[0] + '_'+sensor}}_checkbox_hidden" value="off">
                                                                                                    <i></i>{{sensor}}
                                                                                                </label>
                                                                                            {%endif%}
                                                                                            {%if sensor not in device[2] and count == 4%}
                                                                                                <label class="checkbox">
                                                                                                    <input type="checkbox" name="{{sensor}}" id="{{device[0] + '_'+sensor}}_checkbox">
                                                                                                    <input type="hidden" name="{{sensor}}" id="{{device[0] + '_'+sensor}}_checkbox_hidden" value="off">
                                                                                                    <i></i>{{sensor}}
                                                                                                </label>
                                                                                            </div>
                                                                                            <div class="col col-6">
                                                                                            {%endif%}
                                                                                            {%if sensor not in device[2] and count > 4%}
                                                                                                <label class="checkbox">
                                                                                                    <input type="checkbox" name="{{sensor}}" id="{{device[0] + '_'+sensor}}_checkbox">
                                                                                                    <input type="hidden" name="{{sensor}}" id="{{device[0] + '_'+sensor}}_checkbox_hidden" value="off">
                                                                                                    <i></i>{{sensor}}
                                                                                                </label>
                                                                                            {%endif%}
                                                                                        {%endfor%}
                                                                                </div>
                                                                            {%endif%}
                                                                    </div>
                                                                </section>
                                                            </fieldset>

                                                            <fieldset>
                                                                <section>
                                                                    <label class="label"><h4>Actuators</h4></label>
                                                                    {% for key, value in device[3].items() %}
                                                                        <div class="col col-6">
                                                                            <section>
                                                                                <label class="label">{{key[0].capitalize()+key[1:].replace('_', ' ')}}</label>
                                                                                <label class="input">
                                                                                    <input id="{{device[0] + key + '_pin'}}" name="{{key + '_pin'}}" type="text" class="input-xs" data-mask="99" value="{{value}}" placeholder="Pin #">
                                                                                </label>
                                                                            </section>
                                                                        </div>
                                                                    {% endfor %}
                                                                    {% if 'light_1' not in device[3].keys() %}
                                                                        <div class="col col-6">
                                                                            <section>
                                                                                <label class="label">Light 1</label>
                                                                                <label class="input">
                                                                                    <input id="{{device[0]}}_light_1_pin" name="light_1_pin" type="text" class="input-xs" data-mask="99" placeholder="Pin #">
                                                                                </label>
                                                                            </section>
                                                                        </div>
                                                                    {% endif %}
                                                                    {% if 'light_2' not in device[3].keys() %}
                                                                        <div class="col col-6">
                                                                            <section>
                                                                                <label class="label">Light 2</label>
                                                                                <label class="input">
                                                                                    <input id="{{device[0]}}_light_2_pin" name="light_2_pin" type="text" class="input-xs bryan" data-mask="99" placeholder="Pin #">
                                                                                </label>
                                                                            </section>
                                                                        </div>
                                                                    {% endif %}
                                                                    {% if 'water_pump' not in device[3].keys() %}
                                                                        <div class="col col-6">
                                                                            <section>
                                                                                <label class="label">Water Pump</label>
                                                                                <label class="input">
                                                                                    <input id="{{device[0]}}_water_pump_pin" name="water_pump_pin" type="text" class="input-xs" data-mask="99"placeholder="Pin #">
                                                                                </label>
                                                                            </section>
                                                                        </div>
                                                                    {% endif %}
                                                                    {% if 'nutrient_pump' not in device[3].keys() %}
                                                                        <div class="col col-6">
                                                                            <section>
                                                                                <label class="label">Nutrient Pump</label>
                                                                                <label class="input">
                                                                                    <input id="{{device[0]}}_nutrient_pump_pin" name="nutrient_pump_pin" type="text" class="input-xs" data-mask="99" placeholder="Pin #">
                                                                                </label>
                                                                            </section>
                                                                        </div>
                                                                    {% endif %}
                                                                    {% if 'phUpper_pump' not in device[3].keys() %}
                                                                        <div class="col col-6">
                                                                            <section>
                                                                                <label class="label">ph Upper Pump</label>
                                                                                <label class="input">
                                                                                    <input id="{{device[0]}}_phUpper_pump_pin" name="phUpper_pump_pin" type="text" class="input-xs" data-mask="99" placeholder="Pin #">
                                                                                </label>
                                                                            </section>
                                                                        </div>
                                                                    {% endif %}
                                                                    {% if 'phDowner_pump' not in device[3].keys() %}
                                                                        <div class="col col-6">
                                                                            <section>
                                                                                <label class="label">pH Downer Pump</label>
                                                                                <label class="input">
                                                                                    <input id="{{device[0]}}_phDowner_pump_pin" name="phDowner_pump_pin" type="text" class="input-xs" data-mask="99" placeholder="Pin #">
                                                                                </label>
                                                                            </section>
                                                                        </div>
                                                                    {% endif %}
                                                                    </section>
                                                                    <div class="col col-12 device_info">
                                                                        <label class="label">Publish Key</label>
                                                                        <pre class="device_keys">char pubkey[] = "pub-c-5bef0e0e-e177-4a94-b06f-ce3c1355e5cd";</pre>
                                                                        <label class="label">Subscribe Key</label>
                                                                        <pre class="device_keys">char subkey[] = "sub-c-3c8b80da-de67-11e5-abb9-0619f8945a4f";</pre>
                                                                        <label class="label">Authorization Key</label>
                                                                        <pre class="device_keys">char authkey[] = "40ed6434-1991-4f7a-8034-20a072abde43";</pre>
                                                                        <label class="label">Channel</label>
                                                                        <pre class="device_keys">char channel[] = "{{username}}";</pre>
                                                                        <label class="label">Device ID</label>
                                                                        <pre class="device_keys">char deviceid[] = "{{device[5]}}";</pre>
                                                                    </div>
                                                            </fieldset>
                                                        </section>

                                                        <div class="modal-footer">
                                                            <button style="margin-top: 20px; margin-left: 0px; padding: 6px 12px; width: 100%" type="submit" class="btn btn-primary">Save Edits</button>
                                                            <button style="margin-top: 20px; margin-left: 0px; padding: 6px 12px; width: 100%" type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                                        </div>
                                                    </form>
                                                    <form action="{{'/delete_device/'+device[5]}}" method="POST">
                                                        <button style="margin-top: 20px; width: 100%" type="submit" class="btn btn-danger">Delete Device</button>
                                                        <input type="hidden" name="device_delete" value="true">
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- end widget content -->

                            </div>
                            <!-- end widget div -->

                        </div>
                        <!-- end widget -->
                    </article>
                {% endfor %}
            </div>
            <!-- end row -->
        </section>
        <!-- end widget grid -->
    </div>
    <!-- END MAIN CONTENT -->
</div>
<!-- END MAIN PANEL -->

<!-- Add Device Button -->
<a class="add_device"  data-toggle="modal" data-target="#add_new_device_modal"><img src="./../static/img/flat_plus.png"></a>
<!-- End of Button Device Button -->
<!-- Add Device Modal -->
<div id="add_new_device_modal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add A New Device</h4>
            </div>
            <div class="modal-body">
                <form class="smart-form" id="new_device_form" action="{{'/add_device/'+uuid}}" method="POST">
                    <fieldset>
                        <section>
                            <label class="label">Device Name</label>
                            <label class="input">
                                <input name="device_name" id="new_device_name" type="text" class="input-sm">
                            </label>
                        </section>
                        <section>
                            <label class="label">Did You Use Our Kit?</label>
                            <div class="inline-group">
                                <label class="radio">
                                    <input type="radio" name="kit" value="standard" id="kit_yes">
                                    <i></i>Yes
                                </label>
                                <label class="radio">
                                    <input type="radio" name="kit" value="custom" id="kit_no">
                                    <i></i>No
                                </label>
                            </div>
                        </section>
                    </fieldset>
                    <section id="setUp_options">
                        <header>
                            Set Up
                        </header>
                        <fieldset>
                            <section>
                                <label class="label">Device Type</label>
                                <label class="input">
                                    <input type="text" list="device_type" name="device_type">
                                    <datalist id="device_type">
                                        <option value="ESP32">ESP32</option>
                                        <option value="Photon">Photon</option>
                                        <option value="Raspberry Pi">Raspberry Pi</option>
                                        <option value="Other">Other</option>
                                    </datalist>
                                </label>
                            </section>
                        </fieldset>

                        <fieldset>
                            <section>
                                <label class="label"><h4>Sensors</h4></label>
                                <div class="row">
                                    <div class="col col-6">
                                        <label class="checkbox">
                                            <input type="checkbox" name="Lux" id="new_device_lux_checkbox">
                                            <input type="hidden" name="Lux" id="new_device_lux_checkbox_hidden" value="off">
                                                <i></i>Lux
                                        </label>
                                        <label class="checkbox">
                                            <input type="checkbox" name="Water_Temp" id="new_device_waterTemp_checkbox">
                                            <input type="hidden" name="Water_Temp" id="new_device_waterTemp_checkbox_hidden" value="off">
                                                <i></i>Water Temperature
                                        </label>
                                        <label class="checkbox">
                                            <input type="checkbox" name="Air_Temp" id="new_device_airTemp_checkbox">
                                            <input type="hidden" name="Air_Temp" id="new_device_airTemp_checkbox_hidden" value="off">
                                                <i></i>Air Temperature
                                        </label>
                                        <label class="checkbox">
                                            <input type="checkbox" name="Humidity" id="new_device_humidity_checkbox">
                                            <input type="hidden" name="Humidity" id="new_device_humidity_checkbox_hidden" value="off">
                                                <i></i>Humidity
                                        </label>
                                    </div>
                                    <div class="col col-6">
                                        <label class="checkbox">
                                            <input type="checkbox" name="pH" id="new_device_ph_checkbox">
                                            <input type="hidden" name="pH" id="new_device_ph_checkbox_hidden" value="off">
                                                <i></i>pH
                                        </label>
                                        <label class="checkbox">
                                            <input type="checkbox" name="EC" id="new_device_ec_checkbox">
                                            <input type="hidden" name="EC" id="new_device_ec_checkbox_hidden" value="off">
                                                <i></i>EC
                                        </label>
                                        <label class="checkbox">
                                            <input type="checkbox" name="TDS" id="new_device_tds_checkbox">
                                            <input type="hidden" name="TDS" id="new_device_tds_checkbox_hidden" value="off">
                                                <i></i>Total Dissolved Solids
                                        </label>
                                        <label class="checkbox">
                                            <input type="checkbox" name="PS" id="new_device_ps_checkbox">
                                            <input type="hidden" name="PS" id="new_device_ps_checkbox_hidden" value="off">
                                                <i></i>Practical Salinity
                                        </label>
                                    </div>
                                </div>
                            </section>
                        </fieldset>

                        <fieldset>
                            <section>
                                <label class="label"><h4>Actuators</h4></label>
                                <div class="col col-6">
                                    <section>
                                        <label class="label">Light 1</label>
                                        <label class="input">
                                            <input name="light_1_pin" type="text" class="input-xs" data-mask="99" placeholder="Pin #">
                                        </label>
                                    </section>
                                </div>
                                <div class="col col-6">
                                    <section>
                                        <label class="label">Light 2</label>
                                        <label class="input">
                                            <input name="light_2_pin" type="text" class="input-xs" data-mask="99" placeholder="Pin #">
                                        </label>
                                    </section>
                                </div>
                                <div class="col col-3">
                                    <section>
                                        <label class="label">Water Pump</label>
                                        <label class="input">
                                            <input name="water_pump_pin" type="text" class="input-xs" data-mask="99" placeholder="Pin #">
                                        </label>
                                    </section>
                                </div>
                                <div class="col col-3">
                                    <section>
                                        <label class="label">Nutrient Pump</label>
                                        <label class="input">
                                            <input name="nutrient_pump_pin" type="text" class="input-xs" data-mask="99" placeholder="Pin #">
                                        </label>
                                    </section>
                                </div>
                                <div class="col col-3">
                                    <section>
                                        <label class="label">pH Upper</label>
                                        <label class="input">
                                            <input name="phUpper_pump_pin" type="text" class="input-xs" data-mask="99" placeholder="Pin #">
                                        </label>
                                    </section>
                                </div>
                                <div class="col col-3">
                                    <section>
                                        <label class="label">pH Downer</label>
                                        <label class="input">
                                            <input name="phDowner_pump_pin" type="text" class="input-xs" data-mask="99" placeholder="Pin #">
                                        </label>
                                    </section>
                                </div>
                            </section>
                        </fieldset>
                    </section>
                    <div class="modal-footer">
                        <button style="margin-top: 20px" type="submit" class="btn btn-primary btn-xs">Save New Device</button>
                        <button style="margin-top: 20px" type="button" class="btn btn-default btn-xs" data-dismiss="modal">Cancel</button>
                    </div>
                </form>
                <div style="margin-top: 20px" class="modal-footer" id="base_sketch">
                    <div class="jarviswidget jarviswidget-color-greenDark" data-widget-colorbutton="false" data-widget-editbutton="false" data-widget-deletebutton="false" data-widget-sortable="false">
                        <!-- widget options:
                            usage: <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">

                            data-widget-colorbutton="false"
                            data-widget-editbutton="false"
                            data-widget-togglebutton="false"
                            data-widget-deletebutton="false"
                            data-widget-fullscreenbutton="false"
                            data-widget-custombutton="false"
                            data-widget-collapsed="true"
                            data-widget-sortable="false"

                        -->
                        <header>
                            <span class="widget-icon"> <i class="fa fa-code"></i> </span>
                            <h2><strong>Arduino Code</strong></h2>

                        </header>

                        <!-- widget div-->
                        <div>
                            <!-- widget content -->
                            <div class="widget-body">
                                <pre style="height: 200px">
/**********************************************************************************
 ***********************************************************************************
 * Start Temp-Humid Set-Up
 ***********************************************************************************
 **********************************************************************************/
#include "DHT.h"
#define DHTPIN 2     // what digital pin we're connected to
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);
/***********************************************************************************
 ***********************************************************************************
 * End Temp-Humid Sensor Set-Up
 ***********************************************************************************
 ***********************************************************************************/

/**********************************************************************************
 ***********************************************************************************
 * Start Water Temp Set-Up
 ***********************************************************************************
 **********************************************************************************/
#include &lt;OneWire.h&gt;
int DS18S20_Pin = 4;
OneWire ds(DS18S20_Pin);
/***********************************************************************************
 ***********************************************************************************
 * End Water Temp Sensor Set-Up
 ***********************************************************************************
 ***********************************************************************************/

/**********************************************************************************
 ***********************************************************************************
 * Start Ethernet+PubNub Set-Up
 ***********************************************************************************
 **********************************************************************************/
#include &lt;SPI.h&gt;
#include &lt;Ethernet.h&gt;
#include &lt;PubNub.h&gt;
#include &lt;aJSON.h&gt;

// Some Ethernet shields have a MAC address printed on a sticker on the shield;
// fill in that address here, or choose your own at random:
byte mac[] = { 0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0xED };

char pubkey[] = "pub-c-5bef0e0e-e177-4a94-b06f-ce3c1355e5cd";
char subkey[] = "sub-c-3c8b80da-de67-11e5-abb9-0619f8945a4f";
char authkey[] = "40ed6434-1991-4f7a-8034-20a072abde43";
char channel[] = "{{username}}";
char deviceid[] = "{{uuid}}";

aJsonObject *createMessage()
{
  aJsonObject *msg = aJson.createObject();

  aJsonObject *sender = aJson.createObject();
  aJson.addStringToObject(sender, "device_id", "{{uuid}}");
  aJson.addItemToObject(msg, "sender", sender);
  return msg;
}

/* Process message like: { "pwm": { "8": 0, "9": 255 } } */
void processActuatorInfo(aJsonObject *item)
{
  aJsonObject *actuators = aJson.getObjectItem(item, "{{uuid}}");
  if (!actuators) {
    Serial.println("not for me");
    return;
  }

  const static int pins[] = { 30, 31, 32, 33, 34, 35 };
  const static int pins_n = 6;
  for (int i = 0; i &lt; pins_n; i++) {
    char pinstr[3];
    snprintf(pinstr, sizeof(pinstr), "%d", pins[i]);

    aJsonObject *actuatorsVal = aJson.getObjectItem(actuators, pinstr);
    if (!actuatorsVal) continue; /* Value not provided, ok. */
    if (actuatorsVal-&gt;type != aJson_Int) {
      Serial.print(" invalid data type ");
      Serial.print(actuatorsVal-&gt;type, DEC);
      Serial.print(" for pin ");
      Serial.println(pins[i], DEC);
      continue;
    }

    Serial.print(" setting pin ");
    Serial.print(pins[i], DEC);
    Serial.print(" to value ");
    Serial.println(actuatorsVal-&gt;valueint, DEC);
    analogWrite(pins[i], actuatorsVal-&gt;valueint);
  }
}

void dumpMessage(Stream &s, aJsonObject *msg)
{
  int msg_count = aJson.getArraySize(msg);
  for (int i = 0; i &lt; msg_count; i++) {
    aJsonObject *item, *sender, *analog, *value;
    //s.print("Msg #");
    //s.println(i, DEC);

    item = aJson.getArrayItem(msg, i);
    if (!item) { s.println("item not acquired"); delay(1000); return; }

    processActuatorInfo(item);

    /* Below, we parse and dump messages from fellow Arduinos. */

    sender = aJson.getObjectItem(item, "sender");
    if (!sender) { s.println("sender not acquired"); delay(1000); return; }

    s.print(" A2: ");
    analog = aJson.getObjectItem(item, "analog");
    if (!analog) { s.println("analog not acquired"); delay(1000); return; }
    value = aJson.getArrayItem(analog, 2);
    if (!value) { s.println("analog[2] not acquired"); delay(1000); return; }
    s.print(value-&gt;valueint, DEC);

    s.println();
  }
}

/***********************************************************************************
 ***********************************************************************************
 * Actuator Pin Set-Up
 ***********************************************************************************
 **********************************************************************************/

int light1 = 30;
int light2 = 31;
int waterTrigger = 32;
int nutrientDoser = 33;
int phUP = 34;
int phDOWN = 35;

/***********************************************************************************
 ***********************************************************************************
 * End Pin Set-Up
 ***********************************************************************************
 **********************************************************************************/



/***********************************************************************************
 ***********************************************************************************
 * Lux Sensor Set-Up
 ***********************************************************************************
 **********************************************************************************/
#include &lt;Wire.h&gt;
#include &lt;Adafruit_Sensor.h&gt;
#include &lt;Adafruit_TSL2561_U.h&gt;
Adafruit_TSL2561_Unified tsl = Adafruit_TSL2561_Unified(TSL2561_ADDR_FLOAT, 12345);

/*************************************************************************
    Configures the gain and integration time for the TSL2561
*************************************************************************/
void configureSensor(void)
{
  /* You can also manually set the gain or enable auto-gain support */
  tsl.enableAutoRange(true);            /* Auto-gain ... switches automatically between 1x and 16x */

  /* Changing the integration time gives you better sensor resolution (402ms = 16-bit data) */
  tsl.setIntegrationTime(TSL2561_INTEGRATIONTIME_13MS);      /* fast but low resolution */
  // tsl.setIntegrationTime(TSL2561_INTEGRATIONTIME_101MS);  /* medium resolution and speed   */
  // tsl.setIntegrationTime(TSL2561_INTEGRATIONTIME_402MS);  /* 16-bit data but slowest conversions */

  /* Update these values depending on what you've set above!
  Serial.println("------------------------------------");
  Serial.print  ("Gain:         "); Serial.println("Auto");
  Serial.print  ("Timing:       "); Serial.println("13 ms");
  Serial.println("------------------------------------");
  */
}

/***********************************************************************************
 ***********************************************************************************
 * End Lux Sensor Set-Up
 ***********************************************************************************
 **********************************************************************************/


/***********************************************************************************
 ***********************************************************************************
 * Tentacle Set-Up
 ***********************************************************************************
 **********************************************************************************/

#include &lt;SoftwareSerial.h&gt;              //Include the software serial library
#include &lt;Wire.h&gt;                   //enable I2C.

SoftwareSerial sSerial(11, 10);          // RX, TX  - Name the software serial library sSerial (this cannot be omitted)
                                         // assigned to pins 10 and 11 for maximum compatibility

const int s0 = 7;                        //Arduino pin 7 to control pin S0
const int s1 = 6;                        //Arduino pin 6 to control pin S1
const int enable_1 = 5;                //Arduino pin 5 to control pin E on shield 1
const int enable_2 = 4;                  //Arduino pin 4 to control pin E on shield 2

char sensordata[30];                     //A 30 byte character array to hold incoming data from the sensors
byte computer_bytes_received = 0;        //We need to know how many characters bytes have been received
byte sensor_bytes_received = 0;          //We need to know how many characters bytes have been received
int tenticleChannel;                             //INT pointer for channel switching - 0-7 serial, 8-127 I2C addresses
char *cmd;                               //Char pointer used in string parsing
int retries;                             // com-check functions store number of retries here
boolean answerReceived;                  // com-functions store here if a connection-attempt was successful
byte error;                              // error-byte to store result of Wire.transmissionEnd()

String stamp_type;                       // hold the name / type of the stamp
char stamp_version[4];                   // hold the version of the stamp

char computerdata[20];             //we make a 20 byte character array to hold incoming data from a pc/mac/other.

byte i2c_response_code = 0;              //used to hold the I2C response code.
byte in_char = 0;                    //used as a 1 byte buffer to store in bound bytes from an I2C stamp.

/***********************************************************************************
 ***********************************************************************************
 * Tentacle Sensor Set-Up
 ***********************************************************************************
 **********************************************************************************/


void setup() {
  // put your setup code here, to run once:
  Serial.begin(9600);
  Serial.println("Serial set up");

  pinMode(s1, OUTPUT);                   //Set the digital pin as output.
  pinMode(s0, OUTPUT);                   //Set the digital pin as output.
  pinMode(enable_1, OUTPUT);             //Set the digital pin as output.
  pinMode(enable_2, OUTPUT);             //Set the digital pin as output.
  sSerial.begin(38400);                  // Set the soft serial port to 38400
  Wire.begin();                          // enable I2C port.


  while (!Ethernet.begin(mac)) {
    Serial.println("Ethernet setup error");
    delay(1000);
  }
  Serial.println("Ethernet set up");

  PubNub.begin(pubkey, subkey, authkey);
  Serial.println("PubNub set up");

   /******** Initialise the Lux Sensor ********/
  if(!tsl.begin())
  {
    /* There was a problem detecting the ADXL345 ... check your connections */
    Serial.print("Ooops, no TSL2561 detected ... Check your wiring or I2C ADDR!");
    while(1);
  }

  configureSensor();
  /******** End Lux initialization ********/

  /******** Temp-Humid Sensor ********/
  dht.begin();
  /******** End Temp-Humid init ********/
  pinMode(light1, OUTPUT);
  pinMode(light2, OUTPUT);
  pinMode(waterTrigger, OUTPUT);
  pinMode(nutrientDoser, OUTPUT);
  pinMode(phUP, OUTPUT);
  pinMode(phDOWN, OUTPUT);
  digitalWrite(light1, HIGH);
  digitalWrite(light2, HIGH);
  digitalWrite(waterTrigger, HIGH);
  digitalWrite(nutrientDoser, HIGH);
  digitalWrite(phUP, HIGH);
  digitalWrite(phDOWN, HIGH);
}

/**********************************************************************************
 ***********************************************************************************
 * End Ethernet+PubNub Set-Up
 ***********************************************************************************
 **********************************************************************************/


void loop() {
  int lux = 0;
  /********** Lux Sensor Start **********/
  /* Get a new sensor event */
  sensors_event_t event;
  tsl.getEvent(&event);

  /* Display the results (light is measured in lux) */
  if (event.light)
  {
    lux = event.light;
  }
  else
  {
    /* If event.light = 0 lux the sensor is probably saturated
       and no reliable data could be generated! */
    Serial.println("Sensor overload");
  }
  /********** End Lux Sensor **********/


  /********** Start Temp-Humid Sensor **********/
  int h = dht.readHumidity();
  int f = dht.readTemperature(true);

  //Validate Temp-Humid Readings
  if (isnan(h) || isnan(f)) {
    Serial.println("Failed to read from DHT sensor!");
    return;
  }
  /********** End Temp-Humid Sensor **********/

  float waterTemp = getWaterTemp();
  waterTemp = (waterTemp*1.8)+32.0;

  Ethernet.maintain();

  EthernetClient *client;

  /* Publish */

  Serial.print("publishing a message: ");
  aJsonObject *msg = createMessage();

 /*Add to message aJsonObject */
  aJsonObject *luxData = aJson.createItem(lux);
  aJson.addItemToObject(msg, "lux", luxData);
  aJsonObject *humidityData = aJson.createItem(h);
  aJson.addItemToObject(msg, "humidity", humidityData);
  aJsonObject *tempData = aJson.createItem(f);
  aJson.addItemToObject(msg, "airTemp", tempData);
  aJsonObject *watertempData = aJson.createItem(waterTemp);
  aJson.addItemToObject(msg, "waterTemp", watertempData);

  tenticleChannel = 99;
  cmd = "r";
  I2C_call();  // send i2c command and wait for answer
  if (sensor_bytes_received &gt; 0) {
    Serial.print("Current pH: ");
    Serial.println(sensordata);       //print the data.
    aJsonObject *phData = aJson.createItem(sensordata);
    aJson.addItemToObject(msg, "pH", phData);
  }

  tenticleChannel = 100;
  cmd = "r";
  I2C_call();  // send i2c command and wait for answer
  if (sensor_bytes_received &gt; 0) {
    Serial.print("Current pH: ");
    Serial.println(sensordata);       //print the data.
    aJsonObject *ecData = aJson.createItem(sensordata);
    aJson.addItemToObject(msg, "EC", ecData);
  }



  char *msgStr = aJson.print(msg);
  aJson.deleteItem(msg);

  // msgStr is returned in a buffer that can be potentially
  // needlessly large; this call will "tighten" it
  msgStr = (char *) realloc(msgStr, strlen(msgStr) + 1);

  Serial.println(msgStr);
  client = PubNub.publish(channel, msgStr);
  free(msgStr);
  if (!client) {
    Serial.println("publishing error");
    delay(1000);
    return;
  }
  client-&gt;stop();

  /* Subscribe and load reply */

  Serial.println("waiting for a message (subscribe)");
  client = PubNub.subscribe(channel);
  if (!client) {
    Serial.println("subscription error");
    delay(1000);
    return;
  }

  /* Parse */

  aJsonClientStream stream(client);
  msg = aJson.parse(&stream);
  client-&gt;stop();
  if (!msg) { Serial.println("parse error"); delay(1000); return; }
  dumpMessage(Serial, msg);
  aJson.deleteItem(msg);

}


/*tentacle shield stuffems*/

byte I2C_call() {           //function to parse and call I2C commands.
  sensor_bytes_received = 0;                            // reset data counter
  memset(sensordata, 0, sizeof(sensordata));            // clear sensordata array;

  Wire.beginTransmission(tenticleChannel);                  //call the circuit by its ID number.
  Wire.write(cmd);                      //transmit the command that was sent through the serial port.
  Wire.endTransmission();                           //end the I2C data transmission.

  i2c_response_code = 254;
  while (i2c_response_code == 254) {      // in case the cammand takes longer to process, we keep looping here until we get a success or an error

    if (String(cmd).startsWith(F("cal")) || String(cmd).startsWith(F("Cal")) ) {
      delay(1400);                        // cal-commands take 1300ms or more
    } else if (String(cmd) == F("r") || String(cmd) == F("R")) {
      delay(1000);                        // reading command takes about a second
    }
    else {
      delay(300);                         // all other commands: wait 300ms
    }

    Wire.requestFrom(tenticleChannel, 48, 1);     //call the circuit and request 48 bytes (this is more then we need).
    i2c_response_code = Wire.read();      //the first byte is the response code, we read this separately.

    while (Wire.available()) {            //are there bytes to receive.
      in_char = Wire.read();              //receive a byte.

      if (in_char == 0) {                 //if we see that we have been sent a null command.
        Wire.endTransmission();           //end the I2C data transmission.
        break;                            //exit the while loop.
      }
      else {
        sensordata[sensor_bytes_received] = in_char;        //load this byte into our array.
        sensor_bytes_received++;
      }
    }

    switch (i2c_response_code) {         //switch case based on what the response code is.
      case 1:                          //decimal 1.
        Serial.println( F("&lt; success"));     //means the command was successful.
        break;                           //exits the switch case.

      case 2:                          //decimal 2.
        Serial.println( F("&lt; command failed"));     //means the command has failed.
        break;                           //exits the switch case.

      case 254:                        //decimal 254.
        Serial.println( F("&lt; command pending"));    //means the command has not yet been finished calculating.
        break;                           //exits the switch case.

      case 255:                        //decimal 255.
        Serial.println( F("No Data"));    //means there is no further data to send.
        break;                           //exits the switch case.
    }
  }
}

boolean check_i2c_connection() {                      // check selected i2c channel/address. verify that it's working by requesting info about the stamp

  retries = 0;

  while (retries &lt; 3) {
    retries++;
    Wire.beginTransmission(tenticleChannel);      // just do a short connection attempt without command to scan i2c for devices
    error = Wire.endTransmission();

    if (error == 0)                       // if error is 0, there's a device
    {

      int r_retries = 0;
      while (r_retries &lt; 3) {
        cmd = "i";                          // set cmd to request info (in I2C_call())
        I2C_call();

        if (parseInfo()) {
          return true;
        }
      }
      return false;
    }
    else
    {
      return false;                      // no device at this address
    }
  }

}



boolean parseInfo() {                  // parses the answer to a "i" command. returns true if answer was parseable, false if not.

  // example:
  // PH EZO  -&gt; '?I,pH,1.1'
  // ORP EZO -&gt; '?I,OR,1.0'   (-&gt; wrong in documentation 'OR' instead of 'ORP')
  // DO EZO  -&gt; '?I,D.O.,1.0' || '?I,DO,1.7' (-&gt; exists in D.O. and DO form)
  // EC EZO  -&gt; '?I,EC,1.0 '

  // Legazy PH  -&gt; 'P,V5.0,5/13'
  // Legazy ORP -&gt; 'O,V4.4,2/13'
  // Legazy DO  -&gt; 'D,V5.0,1/13'
  // Legazy EC  -&gt; 'E,V3.1,5/13'

  if (sensordata[0] == '?' && sensordata[1] == 'I') {          // seems to be an EZO stamp

    // PH EZO
    if (sensordata[3] == 'p' && sensordata[4] == 'H') {
      stamp_type = F("pH EZO");
      stamp_version[0] = sensordata[6];
      stamp_version[1] = sensordata[7];
      stamp_version[2] = sensordata[8];
      stamp_version[3] = 0;

      return true;

      // ORP EZO
    }
    else if (sensordata[3] == 'O' && sensordata[4] == 'R') {
      stamp_type = F("ORP EZO");
      stamp_version[0] = sensordata[6];
      stamp_version[1] = sensordata[7];
      stamp_version[2] = sensordata[8];
      stamp_version[3] = 0;
      return true;

      // DO EZO
    }
    else if (sensordata[3] == 'D' && sensordata[4] == 'O') {
      stamp_type = F("D.O. EZO");
      stamp_version[0] = sensordata[6];
      stamp_version[1] = sensordata[7];
      stamp_version[2] = sensordata[8];
      stamp_version[3] = 0;
      return true;

      // D.O. EZO
    }
    else if (sensordata[3] == 'D' && sensordata[4] == '.' && sensordata[5] == 'O' && sensordata[6] == '.') {
      stamp_type = F("D.O. EZO");
      stamp_version[0] = sensordata[8];
      stamp_version[1] = sensordata[9];
      stamp_version[2] = sensordata[10];
      stamp_version[3] = 0;
      return true;

      // EC EZO
    }
    else if (sensordata[3] == 'E' && sensordata[4] == 'C') {
      stamp_type = F("EC EZO");
      stamp_version[0] = sensordata[6];
      stamp_version[1] = sensordata[7];
      stamp_version[2] = sensordata[8];
      stamp_version[3] = 0;
      return true;

      // unknown EZO stamp
    }
    else {
      stamp_type = F("unknown EZO stamp");
      return true;
    }

  }

  // it's a legacy stamp (non-EZO)
  else
  {
    // Legacy pH
    if ( sensordata[0] == 'P') {
      stamp_type = F("pH (legacy)");
      stamp_version[0] = sensordata[3];
      stamp_version[1] = sensordata[4];
      stamp_version[2] = sensordata[5];
      stamp_version[3] = 0;
      return true;

      // legacy ORP
    }
    else if ( sensordata[0] == 'O') {
      stamp_type = F("ORP (legacy)");
      stamp_version[0] = sensordata[3];
      stamp_version[1] = sensordata[4];
      stamp_version[2] = sensordata[5];
      stamp_version[3] = 0;
      return true;

      // Legacy D.O.
    }
    else if ( sensordata[0] == 'D') {
      stamp_type = F("D.O. (legacy)");
      stamp_version[0] = sensordata[3];
      stamp_version[1] = sensordata[4];
      stamp_version[2] = sensordata[5];
      stamp_version[3] = 0;
      return true;

      // Lecagy EC
    }
    else if ( sensordata[0] == 'E') {
      stamp_type = F("EC (legacy)");
      stamp_version[0] = sensordata[3];
      stamp_version[1] = sensordata[4];
      stamp_version[2] = sensordata[5];
      stamp_version[3] = 0;
      return true;
    }
  }

  /*
  Serial.println("can not parse data: ");
   Serial.print("'");
   Serial.print(sensordata);
   Serial.println("'");
   */
  return false;        // can not parse this info-string
}



void clearIncomingBuffer() {          // "clears" the incoming soft-serial buffer
  while (sSerial.available() ) {
    //Serial.print((char)sSerial.read());
    sSerial.read();
  }
}

/*end of tenticle stuffems*/


/*Start of waterTemp stuffems*/
float getWaterTemp(){
  //returns the temperature from one DS18S20 in DEG Celsius

  byte data[12];
  byte addr[8];

  if ( !ds.search(addr)) {
      //no more sensors on chain, reset search
      ds.reset_search();
      return -1000;
  }

  if ( OneWire::crc8( addr, 7) != addr[7]) {
      Serial.println("CRC is not valid!");
      return -1000;
  }

  if ( addr[0] != 0x10 && addr[0] != 0x28) {
      Serial.print("Device is not recognized");
      return -1000;
  }

  ds.reset();
  ds.select(addr);
  ds.write(0x44,1); // start conversion, with parasite power on at the end

  byte present = ds.reset();
  ds.select(addr);
  ds.write(0xBE); // Read Scratchpad


  for (int i = 0; i &lt; 9; i++) { // we need 9 bytes
    data[i] = ds.read();
  }

  ds.reset_search();

  byte MSB = data[1];
  byte LSB = data[0];

  float tempRead = ((MSB &lt;&lt; 8) | LSB); //using two's compliment
  float TemperatureSum = tempRead / 16;

  return TemperatureSum;

}</pre>
                            </div>
                            <!-- end widget content -->

                        </div>
                        <!-- end widget div -->

                    </div>
                </div>
            </div>


        </div>

    </div>
</div>
<!-- End Add Device Button -->

<!-- PAGE FOOTER -->
<div class="page-footer">
    <div class="row">
        <div class="col-xs-12 col-sm-12 text-right hidden-xs">
            <div class="txt-color-white inline-block">
                <i class="txt-color-blueLight hidden-mobile">You Look Great Today </i>
                <div class="btn-group dropup">
                    <button class="btn btn-xs dropdown-toggle bg-color-blue txt-color-white" data-toggle="dropdown">
                        <i class="fa fa-link"></i> <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu pull-right text-left">
                        <li>
                            <div class="padding-5">
                                <p class="txt-color-darken font-sm no-margin">Download Progress</p>
                                <div class="progress progress-micro no-margin">
                                    <div class="progress-bar progress-bar-success" style="width: 50%;"></div>
                                </div>
                            </div>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <div class="padding-5">
                                <p class="txt-color-darken font-sm no-margin">Server Load</p>
                                <div class="progress progress-micro no-margin">
                                    <div class="progress-bar progress-bar-success" style="width: 20%;"></div>
                                </div>
                            </div>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <div class="padding-5">
                                <p class="txt-color-darken font-sm no-margin">Memory Load <span class="text-danger">*critical*</span></p>
                                <div class="progress progress-micro no-margin">
                                    <div class="progress-bar progress-bar-danger" style="width: 70%;"></div>
                                </div>
                            </div>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <div class="padding-5">
                                <button class="btn btn-block btn-default">refresh</button>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END PAGE FOOTER -->

<!-- SHORTCUT AREA : With large tiles (activated via clicking user name tag)
Note: These tiles are completely responsive,
you can add as many as you like
-->
<div id="shortcut">
    <ul>
        <li>
            <a href="/edit_profile" class="jarvismetro-tile big-cubes selected bg-color-pinkDark"> <span class="iconbox"> <i class="fa fa-user fa-4x"></i> <span>My Profile </span> </span> </a>
        </li>
    </ul>
</div>
<!-- END SHORTCUT AREA -->

<!--================================================== -->

<!-- PACE LOADER - turn this on if you want ajax loading to show (caution: uses lots of memory on iDevices)-->
<script data-pace-options='{ "restartOnRequestAfter": true }' src="../../static/js/plugin/pace/pace.min.js"></script>

<!-- Link to Google CDN's jQuery + jQueryUI; fall back to local -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script>
    if (!window.jQuery) {
        document.write('<script src="./../static/js/libs/jquery-2.1.1.min.js"><\/script>');
    }
</script>

<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script>
    if (!window.jQuery.ui) {
        document.write('<script src="./../static/js/libs/jquery-ui-1.10.3.min.js"><\/script>');
    }
</script>

<!-- IMPORTANT: APP CONFIG -->
<script src="./../static/js/app.config.js"></script>

<!-- JS TOUCH : include this plugin for mobile drag / drop touch events-->
<script src="./../static/js/plugin/jquery-touch/jquery.ui.touch-punch.min.js"></script>

<!-- BOOTSTRAP JS -->
<script src="./../static/js/bootstrap/bootstrap.min.js"></script>

<!-- CUSTOM NOTIFICATION -->
<script src="./../static/js/notification/SmartNotification.min.js"></script>

<!-- JARVIS WIDGETS -->
<script src="./../static/js/smartwidgets/jarvis.widget.min.js"></script>

<!-- EASY PIE CHARTS -->
<script src="./../static/js/plugin/easy-pie-chart/jquery.easy-pie-chart.min.js"></script>

<!-- SPARKLINES -->
<script src="./../static/js/plugin/sparkline/jquery.sparkline.min.js"></script>

<!-- JQUERY VALIDATE -->
<script src="./../static/js/plugin/jquery-validate/jquery.validate.min.js"></script>

<!-- JQUERY MASKED INPUT -->
<script src="./../static/js/plugin/masked-input/jquery.maskedinput.min.js"></script>

<!-- JQUERY SELECT2 INPUT -->
<script src="./../static/js/plugin/select2/select2.min.js"></script>

<!-- JQUERY UI + Bootstrap Slider -->
<script src="./../static/js/plugin/bootstrap-slider/bootstrap-slider.min.js"></script>

<!-- browser msie issue fix -->
<script src="./../static/js/plugin/msie-fix/jquery.mb.browser.min.js"></script>

<!-- FastClick: For mobile devices -->
<script src="./../static/js/plugin/fastclick/fastclick.min.js"></script>

<!--[if IE 8]>

<h1>Your browser is out of date, please update your browser by going to www.microsoft.com/download</h1>

<![endif]-->

<!-- Demo purpose only -->
<!--<script src="js/demo.min.js"></script>-->

<!-- MAIN APP JS FILE -->
<script src="./../static/js/app.min.js"></script>

<!--pubnub-->
<script src="../../static/js/pubnub/pubnub-3.14.5.min.js"></script>






<script>
    $(document).ready(function() {

        // DO NOT REMOVE : GLOBAL FUNCTIONS!
        pageSetUp();

        /*
         * PAGE RELATED SCRIPTS
         */

        $(".js-status-update a").click(function() {
            var selText = $(this).text();
            var $this = $(this);
            $this.parents('.btn-group').find('.dropdown-toggle').html(selText + ' <span class="caret"></span>');
            $this.parents('.dropdown-menu').find('li').removeClass('active');
            $this.parent().addClass('active');
        });

        /*Set up PubNub Instance*/
        var pubnub = PUBNUB.init({
            publish_key   : 'pub-c-93c6c384-e1a0-412f-87cf-e626aaab6a00',
            subscribe_key : 'sub-c-8ec9d89e-e4aa-11e5-a4f2-0619f8945a4f',
            auth_key : '40ed6434-1991-4f7a-8034-20a072abde43'
        });

        //Set up device and pin list for Emergency Stop
        var deviceDict = {}
        {%for device in my_devices%}
            deviceDict['{{device[5]}}'] = ["{{device[3]['light_1']}}", "{{device[3]['light_2']}}", "{{device[3]['phUpper_pump']}}", "{{device[3]['phDowner_pump']}}", "{{device[3]['water_pump']}}"];
        {%endfor%}

        //"Set Up" Controls
        $('#setUp_options').fadeOut();
        $('#base_sketch').fadeOut();

        function setUpIn() {
            $('#setUp_options').fadeIn(600, "easeInOutQuint")
        }
        function baseIn() {
            $('#base_sketch').fadeIn(600, "easeInOutQuint")
        }


        $('#kit_no').click(function () {
            $('#base_sketch').fadeOut(500, "linear", setUpIn);
        });
        $('#kit_yes').click(function () {
            console.log("it's working!!!");
            $('#setUp_options').fadeOut(500, "easeInOutQuint", baseIn);
        });
        // End "Set Up" Controls

        //Set up Name Validation
        jQuery.validator.addMethod("whiteSpace", function(value, element) {
            // allow any non-whitespace characters as the host part
            return this.optional( element ) || !(/[^a-zA-Z0-9]/gi.test(value));
        }, 'Please do not use any white spaces or special characters.');


        $('#new_device_form').validate({
            rules:{
                device_name: {
                    required: true,
                    whiteSpace: true
                }
            },

            errorPlacement : function(error, element) {
                error.insertAfter(element.parent());
            }
        });

        {% for device in my_devices%}
        $('#{{device[0]}}_edit_device_form').validate({
            rules:{
                device_name: {
                    required: true,
                    whiteSpace: true
                }
            },

            errorPlacement : function(error, element) {
                error.insertAfter(element.parent());
            }
        });
        {% endfor %}


        $('.emergency_stop').click(function(){
            device_id = this.id.split('_')[0];
            console.log(deviceDict[device_id]);
            console.log(deviceDict[device_id].length);
            var offJSON = {};
            /*for production
            for (i=0;i<deviceDict[device_id].length;i++){
                offJSON[deviceDict[device_id][i]] = 0
            }
            */
            for (i=0;i<2;i++){
                offJSON[deviceDict[device_id][i]] = 0
            }
            for (i=2;i<deviceDict[device_id].length;i++){
                offJSON[deviceDict[device_id][i]] = 255
            }
            var fullMessage = {};
            fullMessage[device_id] = offJSON
            console.log(offJSON);
            pubnub.publish({
                channel: "{{username}}",
                message: fullMessage,
                callback: function(m){ console.log(m) }
            });
            $.post('/emergency_stop/'+device_id, "emergency_stop_status=true");
            $('#'+device_id+'_emergency_stop').fadeOut(500);
            function addButton(){
                $('<button id="'+device_id+'_emergency_stop_off" class="btn btn-info emergency_stop_off" style="width:100%">Emergency Stop Off</button>').hide().appendTo('#'+device_id+'_emergency_stop_div').fadeIn(500);
            }
            setTimeout(addButton, 500);
        });

        $('.emergency_stop_off').click(function(){
            device_id = this.id.split('_')[0];
            console.log('#'+device_id+'_emergency_stop_off');
            $('#'+device_id+'_emergency_stop_off').fadeOut(500);
            function addButton(){
                $('<button id="'+device_id+'_emergency_stop" class="btn btn-warning emergency_stop" style="width:100%">Emergency Stop</button>').hide().appendTo('#'+device_id+'_emergency_stop_div').fadeIn(500);
            }
            setTimeout(addButton, 500);
            //emergency_stop_div
            $.post('/emergency_stop/'+device_id, "emergency_stop_status=false");
        });




    });

</script>

<!-- Your GOOGLE ANALYTICS CODE Below -->
<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-XXXXXXXX-X']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
    })();

</script>

</body>

</html>